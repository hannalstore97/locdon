<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sort Đơn Hàng - Hannal Store 97 (Final Pro)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden-area { display: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hiệu ứng nổi bật khi Hover */
        .hover-pop {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-pop:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #000;
        }

        /* Radio Button Custom Logic */
        .radio-card {
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
            opacity: 0.7;
        }
        .radio-card:hover {
            opacity: 1;
            border-color: #9ca3af;
        }
        /* Khi được chọn */
        input:checked + .radio-card {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-width: 2px;
        }
        /* Màu riêng cho từng loại */
        input[value="nb01"]:checked + .radio-card {
            border-color: #16a34a; /* Green */
            background-color: #f0fdf4;
            color: #15803d;
        }
        input[value="nbd"]:checked + .radio-card {
            border-color: #2563eb; /* Blue */
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        /* Upload Zone Active State */
        .upload-zone:hover {
            border-style: solid;
            background-color: #fff;
            transform: scale(1.01);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden">

    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col p-6 justify-between flex-shrink-0 z-10 shadow-lg">
        <div>
            <div class="mb-10">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-black text-white text-xs font-bold px-2 py-1 rounded">V2.0</span>
                    <h1 class="text-xl font-bold text-gray-900">Sort Đơn Hàng</h1>
                </div>
                <p class="text-sm text-gray-500 font-medium">Hannal Store 97</p>
            </div>

            <nav class="space-y-4">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Chọn Nền Tảng</p>
                
                <button id="btn-shopee" onclick="switchTab('shopee')" 
                    class="w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop group relative overflow-hidden">
                    <div class="absolute inset-0 bg-orange-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i class="fa-solid fa-box-open text-2xl mr-4 w-8 text-center relative z-10 transition-colors"></i>
                    <div class="relative z-10">
                        <span class="block font-bold text-lg">Shopee</span>
                        <span class="text-xs text-gray-500">Xử lý đơn Shopee</span>
                    </div>
                </button>

                <button id="btn-tiktok" onclick="switchTab('tiktok')" 
                    class="w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop group relative overflow-hidden">
                    <div class="absolute inset-0 bg-gray-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i class="fa-brands fa-tiktok text-2xl mr-4 w-8 text-center relative z-10 transition-colors"></i>
                    <div class="relative z-10">
                        <span class="block font-bold text-lg">TikTok Shop</span>
                        <span class="text-xs text-gray-500">Xử lý đơn TikTok</span>
                    </div>
                </button>
            </nav>
        </div>
        <div class="text-xs text-gray-400 border-t pt-4">
            <p class="font-semibold">Trạng thái hệ thống:</p>
            <p class="mt-1 text-lg" id="version-text">...</p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center p-4 relative bg-gray-50">
        
        <div class="bg-white rounded-[2rem] shadow-xl border border-gray-100 w-full max-w-4xl p-12 text-center transition-all">
            
            <h2 class="text-3xl font-black text-gray-900 mb-2 tracking-tight">XỬ LÝ ĐƠN HÀNG</h2>
            <p class="text-gray-500 mb-10 text-base">Vui lòng chọn đúng File PDF tương ứng với nền tảng</p>

            <div id="area-shopee" class="fade-in">
                <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100 mb-6 inline-block">
                    <span class="text-orange-700 font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Chế độ: Shopee V7 (Tự động lọc NBD, NB01...)</span>
                </div>

                <label for="file-shopee" class="upload-zone flex flex-col items-center justify-center w-full h-64 border-4 border-orange-300 border-dashed rounded-3xl cursor-pointer bg-orange-50/50 hover:bg-white hover:border-orange-500 hover:shadow-orange-200 hover:shadow-xl transition-all group relative">
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity -z-10"></div>
                    <div class="flex flex-col items-center justify-center pt-5 pb-6 z-10">
                        <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-file-arrow-up text-4xl text-orange-600"></i>
                        </div>
                        <p class="mb-2 text-xl text-gray-700 font-bold group-hover:text-orange-600">Bấm vào đây để chọn File Shopee</p>
                        <p class="text-sm text-gray-400">Chỉ chấp nhận file .PDF</p>
                    </div>
                    <input id="file-shopee" type="file" class="hidden" accept=".pdf" onchange="showFileName(this, 'name-shopee')" />
                </label>
                
                <div id="name-shopee" class="hidden mt-4 animate-bounce">
                    <span class="inline-flex items-center px-4 py-2 rounded-full border border-orange-200 bg-orange-50 text-orange-700 font-bold shadow-sm">
                        <i class="fa-solid fa-check-circle mr-2"></i> <span class="content">Filename.pdf</span>
                    </span>
                </div>
            </div>

            <div id="area-tiktok" class="hidden-area fade-in">
                <div class="grid grid-cols-2 gap-6 mb-8 w-full px-10">
                    <label class="cursor-pointer group relative">
                        <input type="radio" name="tk-mode" value="nb01" checked class="hidden peer" onchange="updateTkMode()">
                        <div class="radio-card h-full rounded-2xl p-6 flex flex-col items-center justify-center gap-3 bg-white shadow-sm hover:shadow-md">
                            <div class="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                <i class="fa-solid fa-filter text-2xl"></i>
                            </div>
                            <span class="font-bold text-lg">Đơn NB Lót (NB01)</span>
                            <span class="text-xs text-gray-500 text-center">Ưu tiên đơn NB01 & Đơn Lạ</span>
                            <div class="absolute top-4 right-4 text-green-500 opacity-0 peer-checked:opacity-100 transform scale-0 peer-checked:scale-100 transition-all">
                                <i class="fa-solid fa-circle-check text-2xl"></i>
                            </div>
                        </div>
                    </label>

                    <label class="cursor-pointer group relative">
                        <input type="radio" name="tk-mode" value="nbd" class="hidden peer" onchange="updateTkMode()">
                        <div class="radio-card h-full rounded-2xl p-6 flex flex-col items-center justify-center gap-3 bg-white shadow-sm hover:shadow-md">
                            <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <i class="fa-solid fa-layer-group text-2xl"></i>
                            </div>
                            <span class="font-bold text-lg">Đơn NB Dài (NBD)</span>
                            <span class="text-xs text-gray-500 text-center">Lọc theo Màu & Size cơ bản</span>
                            <div class="absolute top-4 right-4 text-blue-500 opacity-0 peer-checked:opacity-100 transform scale-0 peer-checked:scale-100 transition-all">
                                <i class="fa-solid fa-circle-check text-2xl"></i>
                            </div>
                        </div>
                    </label>
                </div>

                <label for="file-tiktok" class="upload-zone flex flex-col items-center justify-center w-full h-56 border-4 border-gray-300 border-dashed rounded-3xl cursor-pointer bg-gray-50 hover:bg-white hover:border-black hover:shadow-xl transition-all group">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 group-hover:bg-black group-hover:text-white transition-all">
                            <i class="fa-brands fa-tiktok text-3xl"></i>
                        </div>
                        <p class="mb-1 text-xl text-gray-900 font-bold group-hover:text-black">Chọn File TikTok PDF</p>
                        <p class="text-sm font-medium text-blue-600" id="tk-desc-preview">Đang chọn: NB01</p>
                    </div>
                    <input id="file-tiktok" type="file" class="hidden" accept=".pdf" onchange="showFileName(this, 'name-tiktok')" />
                </label>
                
                 <div id="name-tiktok" class="hidden mt-4 animate-bounce">
                    <span class="inline-flex items-center px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-black font-bold shadow-sm">
                        <i class="fa-solid fa-check-circle mr-2"></i> <span class="content">Filename.pdf</span>
                    </span>
                </div>
            </div>

            <button id="btn-process" onclick="processOrder()" class="mt-10 w-full bg-gray-900 hover:bg-black text-white text-xl font-bold py-5 px-8 rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3">
                <span id="btn-text">BẮT ĐẦU XỬ LÝ NGAY</span>
                <i id="btn-icon" class="fa-solid fa-bolt animate-pulse"></i>
            </button>
            
            <div id="error-log" class="mt-6 text-red-600 font-medium text-sm hidden bg-red-50 p-4 rounded-xl border border-red-200 text-left overflow-auto max-h-32 shadow-inner"></div>
        </div>

    </main>

    <script>
        // Cấu hình Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let currentTab = 'shopee';

        // ================= UI FUNCTIONS =================
        function switchTab(platform) {
            currentTab = platform;
            const btnShopee = document.getElementById('btn-shopee');
            const btnTiktok = document.getElementById('btn-tiktok');
            
            // Style Classes
            const activeClass = "bg-white border-black text-black shadow-lg ring-1 ring-black/5 transform scale-[1.02]";
            const inactiveClass = "bg-transparent border-transparent text-gray-400 hover:bg-gray-50 opacity-60 hover:opacity-100";
            
            // Icon Colors
            const shopeeIcon = btnShopee.querySelector('i');
            const tiktokIcon = btnTiktok.querySelector('i');

            if (platform === 'shopee') {
                btnShopee.className = `w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop relative overflow-hidden ${activeClass}`;
                btnTiktok.className = `w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop relative overflow-hidden ${inactiveClass}`;
                
                shopeeIcon.classList.add('text-orange-500');
                tiktokIcon.classList.remove('text-black');

                document.getElementById('area-shopee').classList.remove('hidden-area');
                document.getElementById('area-tiktok').classList.add('hidden-area');
                
                updateVersionText("Shopee V7", "text-orange-600");
            } else {
                btnShopee.className = `w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop relative overflow-hidden ${inactiveClass}`;
                btnTiktok.className = `w-full flex items-center px-4 py-4 text-left rounded-xl border-2 transition-all hover-pop relative overflow-hidden ${activeClass}`;
                
                shopeeIcon.classList.remove('text-orange-500');
                tiktokIcon.classList.add('text-black');

                document.getElementById('area-shopee').classList.add('hidden-area');
                document.getElementById('area-tiktok').classList.remove('hidden-area');
                updateTkMode(); 
            }
        }

        function updateVersionText(text, colorClass) {
            const v = document.getElementById('version-text');
            v.innerText = text;
            v.className = `mt-1 text-2xl font-black tracking-tight ${colorClass}`;
        }

        function updateTkMode() {
            const mode = document.querySelector('input[name="tk-mode"]:checked').value;
            const preview = document.getElementById('tk-desc-preview');
            
            if (mode === 'nb01') {
                updateVersionText("TIKTOK: NB01", "text-green-600");
                preview.innerText = "Đang chọn logic: NB01 (Lót)";
                preview.className = "text-sm font-bold text-green-600 mt-2";
            } else {
                updateVersionText("TIKTOK: NBD", "text-blue-600");
                preview.innerText = "Đang chọn logic: NBD (Dài)";
                preview.className = "text-sm font-bold text-blue-600 mt-2";
            }
        }

        function showFileName(input, displayId) {
            const displayDiv = document.getElementById(displayId);
            if (input.files && input.files[0]) {
                displayDiv.classList.remove('hidden');
                displayDiv.querySelector('.content').innerText = "Đã chọn: " + input.files[0].name;
                document.getElementById('error-log').classList.add('hidden');
            }
        }

        // Initialize UI
        switchTab('shopee');

        // ================= MAIN CONTROLLER (LOGIC GIỮ NGUYÊN) =================
        async function processOrder() {
            const btn = document.getElementById('btn-process');
            const btnText = document.getElementById('btn-text');
            const errorLog = document.getElementById('error-log');
            
            let fileInput, file, mode;

            if (currentTab === 'shopee') {
                fileInput = document.getElementById('file-shopee');
                mode = 'SHOPEE';
            } else {
                fileInput = document.getElementById('file-tiktok');
                mode = document.querySelector('input[name="tk-mode"]:checked').value === 'nb01' ? 'TIKTOK_NB01' : 'TIKTOK_NBD';
            }

            if (!fileInput.files || !fileInput.files[0]) {
                alert(`⚠️ CHƯA CHỌN FILE PDF! Vui lòng chọn file trước khi bấm xử lý.`);
                return;
            }
            file = fileInput.files[0];

            // UI Loading
            btn.disabled = true;
            btnText.innerText = "ĐANG XỬ LÝ...";
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                let pdfBytes = null;
                let outName = "";

                if (mode === 'SHOPEE') {
                    outName = "SHOPEE_SORT_" + file.name;
                    pdfBytes = await runShopeeLogic(arrayBuffer);
                } else if (mode === 'TIKTOK_NB01') {
                    outName = "NB01_Clean_" + file.name;
                    pdfBytes = await runTikTokNB01Logic(arrayBuffer);
                } else {
                    outName = "NBD_Sort_" + file.name;
                    pdfBytes = await runTikTokGeneralLogic(arrayBuffer);
                }

                // Download
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = outName;
                link.click();
                
                btnText.innerText = "THÀNH CÔNG! ĐANG TẢI VỀ";
                btn.classList.remove('bg-gray-900', 'hover:bg-black');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => { 
                    btnText.innerText = "BẮT ĐẦU XỬ LÝ NGAY"; 
                    btn.disabled = false; 
                    btn.classList.remove('opacity-75', 'cursor-not-allowed', 'bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-gray-900', 'hover:bg-black');
                }, 3000);

            } catch (e) {
                console.error(e);
                errorLog.innerText = "LỖI: " + e.message;
                errorLog.classList.remove('hidden');
                btnText.innerText = "GẶP LỖI!";
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // ================= LOGIC GIỮ NGUYÊN NHƯ CŨ =================
        // (Copy lại toàn bộ hàm logic từ code cũ của bạn vào đây: 
        // runShopeeLogic, classifyPagesShopee, extractItemsShopee, normalizeColorShopee, 
        // addUnique, getPrintOrderShopee, runTikTokNB01Logic, runTikTokGeneralLogic, removeAccents)
        
        async function runShopeeLogic(arrayBuffer) {
            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
            const pdf = await loadingTask.promise;
            let pagesData = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(s => s.str).join(' ');
                pagesData.push({ index: i - 1, text: text });
            }
            const buckets = classifyPagesShopee(pagesData);
            const sortedIndices = getPrintOrderShopee(buckets);
            
            const { PDFDocument } = PDFLib;
            const srcDoc = await PDFDocument.load(arrayBuffer);
            const newDoc = await PDFDocument.create();
            const copiedPages = await newDoc.copyPages(srcDoc, sortedIndices);
            copiedPages.forEach(p => newDoc.addPage(p));
            return await newDoc.save();
        }

        function classifyPagesShopee(pages) {
            const buckets = { NBD: { BLACK: [], NUDE: [], COMBO: [] }, NB01: { BLACK: [], NUDE: [], COMBO: [] }, CB01: [], MULTI: [], OTHER: [] };
            const processedSet = new Set();
            pages.forEach(p => {
                const items = extractItemsShopee(p.text);
                const totalQtyText = (p.text.match(/Tổng\s*SL\s*sản\s*phẩm\s*:\s*(\d+)/i) || [])[1];
                
                const isMulti = (totalQtyText && parseInt(totalQtyText) >= 2) || items.length >= 2 || items.some(it => it.qty >= 2);

                if (isMulti) {
                    addUnique(buckets.MULTI, items[0]?.size || '?', p.index, processedSet);
                    return;
                }
                const it = items[0];
                if (!it) return;

                if (it.code.includes('NBD')) {
                    const c = normalizeColorShopee(it.color);
                    if (c) addUnique(buckets.NBD[c], it.size, p.index, processedSet); 
                    else addUnique(buckets.OTHER, it.size, p.index, processedSet);
                } else if (it.code.includes('NB01')) {
                    const c = normalizeColorShopee(it.color);
                    if (c) addUnique(buckets.NB01[c], it.size, p.index, processedSet);
                    else addUnique(buckets.OTHER, it.size, p.index, processedSet);
                } else if (it.code.includes('CB01')) {
                    addUnique(buckets.CB01, it.size, p.index, processedSet);
                } else {
                    addUnique(buckets.OTHER, it.size, p.index, processedSet);
                }
            });
            pages.forEach(p => { if (!processedSet.has(p.index)) buckets.OTHER.push({ size: 'MISSING', index: p.index }); });
            return buckets;
        }

        function extractItemsShopee(text) {
            let t = text.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
            t = t.replace(/Comb\s+o/gi, 'Combo').replace(/(\d)\s+(XL)/gi, '$1$2');
            const sizePattern = '(XS\\/S|M\\/L|XL\\/XXL|XS|S|M|L|XL|XXL|2XL|3XL|4XL|5XL|6XL)';
            const re = new RegExp(`-\\s*([A-Z0-9 -]+)\\s*,\\s*([^,]+?)\\s*,\\s*${sizePattern}\\s*,\\s*SL\\s*:\\s*(\\d+)`, 'gi');
            const results = [];
            let m;
            while ((m = re.exec(t)) !== null) {
                const code = (m[1]||'').toUpperCase().replace(/\s+/g, '');
                results.push({ code, color: (m[2]||'').trim(), size: (m[3]||'').toUpperCase().replace(/\s+/g, ''), qty: parseInt(m[4]) });
            }
            return results;
        }
        function normalizeColorShopee(c) {
            c = (c || '').toLowerCase();
            if (c.includes('combo')) return 'COMBO';
            if (c.includes('đen') || c.includes('black')) return 'BLACK';
            if (c.includes('nude') || c.includes('da') || c.includes('be')) return 'NUDE';
            return null;
        }
        function addUnique(arr, size, idx, set) { if(!set.has(idx)){ arr.push({size, index: idx}); set.add(idx); } }
        function getPrintOrderShopee(b) {
            const list = [b.NBD.BLACK, b.NBD.NUDE, b.NBD.COMBO, b.NB01.BLACK, b.NB01.NUDE, b.NB01.COMBO, b.CB01, b.MULTI, b.OTHER];
            const order = ['XS/S','XS','S','M/L','M','L','XL/XXL','XL','XXL','2XL','3XL','4XL','5XL','6XL'];
            let res = [];
            list.forEach(g => {
                g.sort((x,y) => {
                   let iX = order.indexOf(x.size); let iY = order.indexOf(y.size);
                   return (iX === -1 ? 999 : iX) - (iY === -1 ? 999 : iY);
                });
                g.forEach(i => res.push(i.index));
            });
            return res;
        }

        async function runTikTokNB01Logic(arrayBuffer) {
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const pdfWriter = await PDFLib.PDFDocument.load(arrayBuffer);
            let groups = [];
            let currentGroup = null;
            
            const SIZE_ORDER = ['xs/s', 'm/l', 'xl/2xl', '3xl', '4xl', '5xl', '6xl'];
            const COLOR_CONFIG = [
                { key: '1c den', rank: 1 }, { key: '1c da', rank: 2 },
                { key: 'combo da + den', rank: 3 }, { key: 'combo 2c den', rank: 4 }, { key: 'combo 2c da', rank: 5 }
            ];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const text = (await page.getTextContent()).items.map(s => s.str).join(' ');
                const cleanText = removeAccents(text);

                if (cleanText.includes('order id') || cleanText.includes('ma don hang') || cleanText.includes('hannal store') || cleanText.includes('recipient')) {
                    let isNB01 = false, colorRank = 99, sizeRank = 99;
                    if (cleanText.includes('nb01')) {
                         const reverseSizes = [...SIZE_ORDER].reverse();
                         for (const size of reverseSizes) {
                            const colorPattern = COLOR_CONFIG.map(c => c.key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                            const regex = new RegExp(`(${colorPattern})\\s*,\\s*(${size})\\b`, 'i');
                            const match = cleanText.match(regex);
                            if (match) {
                                isNB01 = true;
                                const conf = COLOR_CONFIG.find(c => c.key === match[1]);
                                colorRank = conf ? conf.rank : 99;
                                sizeRank = SIZE_ORDER.indexOf(size);
                                break;
                            }
                         }
                    }
                    currentGroup = { headIndex: i - 1, tailIndices: [], colorRank, sizeRank };
                    groups.push(currentGroup);
                } else {
                    if (currentGroup) currentGroup.tailIndices.push(i - 1);
                    else groups.push({ headIndex: i - 1, tailIndices: [], colorRank: 99, sizeRank: 99 });
                }
            }
            
            groups.sort((a, b) => {
                if (a.colorRank !== b.colorRank) return a.colorRank - b.colorRank;
                return a.sizeRank - b.sizeRank;
            });

            const newPdf = await PDFLib.PDFDocument.create();
            for (const g of groups) {
                const [p] = await newPdf.copyPages(pdfWriter, [g.headIndex]);
                newPdf.addPage(p);
                if (g.tailIndices.length) (await newPdf.copyPages(pdfWriter, g.tailIndices)).forEach(tp => newPdf.addPage(tp));
            }
            return await newPdf.save();
        }

        async function runTikTokGeneralLogic(arrayBuffer) {
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const pdfWriter = await PDFLib.PDFDocument.load(arrayBuffer);
            let groups = [];
            let currentGroup = null;
            const TK_SIZE = ['XS', 'S', 'M', 'L', 'XL', '2XL', 'XXL', '3XL', '4XL', '5XL', '6XL'];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const text = (await page.getTextContent()).items.map(s => s.str).join(' ');
                const cleanText = removeAccents(text);

                let found = false, cRank = 99, sRank = 99;
                
                if (cleanText.includes('order id') || cleanText.includes('ma don hang') || cleanText.includes('hannal store')) {
                    const reverseSizes = [...TK_SIZE].reverse();
                    for (const size of reverseSizes) {
                        const m = cleanText.match(new RegExp(`(den|black|nude|da|kem)\\s*,\\s*(${size})\\b`, 'i'));
                        if (m) {
                            found = true;
                            cRank = (m[1].includes('den') || m[1].includes('black')) ? 1 : 2;
                            sRank = TK_SIZE.indexOf(size);
                            break;
                        }
                    }
                    currentGroup = { headIndex: i - 1, tailIndices: [], cRank, sRank };
                    groups.push(currentGroup);
                } else {
                    if (currentGroup) currentGroup.tailIndices.push(i - 1);
                }
            }

            groups.sort((a, b) => (a.cRank - b.cRank) || (a.sRank - b.sRank));

            const newPdf = await PDFLib.PDFDocument.create();
            for (const g of groups) {
                const [p] = await newPdf.copyPages(pdfWriter, [g.headIndex]);
                newPdf.addPage(p);
                if (g.tailIndices.length) (await newPdf.copyPages(pdfWriter, g.tailIndices)).forEach(tp => newPdf.addPage(tp));
            }
            return await newPdf.save();
        }

        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d").replace(/Đ/g, "D").toLowerCase();
        }
    </script>
</body>
</html>
