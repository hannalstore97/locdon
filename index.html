<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sort Đơn Hàng - Hannal Store 97</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden-area { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden">

    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col p-6 justify-between flex-shrink-0">
        <div>
            <div class="mb-10">
                <h1 class="text-xl font-bold text-gray-900">Sort Đơn Hàng</h1>
                <p class="text-sm text-gray-500 mt-1">Hannal Store 97</p>
            </div>

            <nav class="space-y-3">
                <button id="btn-shopee" onclick="switchTab('shopee')" 
                    class="w-full flex items-center px-4 py-3 text-gray-900 bg-white border-2 border-black rounded-xl transition-all hover:bg-gray-50 group shadow-sm font-semibold">
                    <i class="fa-solid fa-box-open text-lg mr-3 w-6 text-center"></i>
                    <span>Shopee</span>
                </button>

                <button id="btn-tiktok" onclick="switchTab('tiktok')" 
                    class="w-full flex items-center px-4 py-3 text-gray-500 bg-transparent border-2 border-transparent rounded-xl hover:bg-gray-100 hover:text-gray-900 transition-all font-medium">
                    <i class="fa-brands fa-tiktok text-lg mr-3 w-6 text-center"></i>
                    <span>TikTok Shop</span>
                </button>
            </nav>
        </div>
        <div class="text-xs text-gray-400">
            <p>Upload PDF &rarr; Sort &rarr; Download</p>
            <p class="mt-1 text-blue-600 font-bold" id="version-text">All in One Version</p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center p-4 relative">
        
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 w-full max-w-3xl p-12 text-center">
            
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Sắp xếp đơn hàng Hannalstore97</h2>
            <p class="text-gray-500 mb-10 text-sm">Công cụ xử lý đơn hàng tự động</p>

            <div id="area-shopee" class="fade-in">
                <label for="file-shopee" class="flex flex-col items-center justify-center w-full h-48 border-2 border-orange-300 border-dashed rounded-2xl cursor-pointer bg-orange-50 hover:bg-orange-100 transition-all">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-file-invoice text-4xl text-orange-500 mb-3"></i>
                        <p class="mb-2 text-lg text-gray-700 font-bold">Chọn file PDF (Shopee)</p>
                        <p class="text-xs text-gray-400">Logic V7: Fix 2XL, NBD, NB01</p>
                    </div>
                    <input id="file-shopee" type="file" class="hidden" accept=".pdf" onchange="showFileName(this, 'name-shopee')" />
                </label>
                <div id="name-shopee" class="hidden mt-3 text-orange-600 font-medium bg-white border border-orange-200 px-4 py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-check mr-2"></i> <span class="content"></span>
                </div>
            </div>

            <div id="area-tiktok" class="hidden-area fade-in">
                <label for="file-tiktok" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-900 border-dashed rounded-2xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-brands fa-tiktok text-4xl text-black mb-3"></i>
                        <p class="mb-2 text-lg text-gray-700 font-bold">Chọn file PDF (TikTok)</p>
                        <p class="text-xs text-gray-400">Logic: Ưu tiên Màu &rarr; Size (Gom trang con)</p>
                    </div>
                    <input id="file-tiktok" type="file" class="hidden" accept=".pdf" onchange="showFileName(this, 'name-tiktok')" />
                </label>
                 <div id="name-tiktok" class="hidden mt-3 text-black font-medium bg-gray-100 border border-gray-200 px-4 py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-check mr-2"></i> <span class="content"></span>
                </div>
            </div>

            <button id="btn-process" onclick="processOrder()" class="mt-8 w-full bg-gray-900 hover:bg-black text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                <span id="btn-text">BẮT ĐẦU XỬ LÝ</span>
                <i id="btn-icon" class="fa-solid fa-bolt"></i>
            </button>
            
            <div id="error-log" class="mt-4 text-red-500 text-sm hidden"></div>
        </div>

    </main>

    <script>
        // Cấu hình Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let currentTab = 'shopee';

        function switchTab(platform) {
            currentTab = platform;
            const btnShopee = document.getElementById('btn-shopee');
            const btnTiktok = document.getElementById('btn-tiktok');
            const activeStyle = "text-gray-900 bg-white border-black font-semibold shadow-sm";
            const inactiveStyle = "text-gray-500 bg-transparent border-transparent font-medium hover:bg-gray-100 hover:text-gray-900";

            if (platform === 'shopee') {
                btnShopee.className = `w-full flex items-center px-4 py-3 rounded-xl border-2 transition-all ${activeStyle}`;
                btnTiktok.className = `w-full flex items-center px-4 py-3 rounded-xl border-2 transition-all ${inactiveStyle}`;
                document.getElementById('area-shopee').classList.remove('hidden-area');
                document.getElementById('area-tiktok').classList.add('hidden-area');
                document.getElementById('version-text').innerText = "Logic Shopee V7";
            } else {
                btnShopee.className = `w-full flex items-center px-4 py-3 rounded-xl border-2 transition-all ${inactiveStyle}`;
                btnTiktok.className = `w-full flex items-center px-4 py-3 rounded-xl border-2 transition-all ${activeStyle}`;
                document.getElementById('area-shopee').classList.add('hidden-area');
                document.getElementById('area-tiktok').classList.remove('hidden-area');
                document.getElementById('version-text').innerText = "Logic TikTok Strict";
            }
        }

        function showFileName(input, displayId) {
            const displayDiv = document.getElementById(displayId);
            if (input.files && input.files[0]) {
                displayDiv.classList.remove('hidden');
                displayDiv.querySelector('.content').innerText = input.files[0].name;
                document.getElementById('error-log').classList.add('hidden');
            }
        }

        // ==========================================
        // MAIN CONTROLLER
        // ==========================================
        async function processOrder() {
            const btn = document.getElementById('btn-process');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');
            const errorLog = document.getElementById('error-log');

            let fileInput = currentTab === 'shopee' ? document.getElementById('file-shopee') : document.getElementById('file-tiktok');
            let platformName = currentTab === 'shopee' ? "Shopee" : "TikTok Shop";

            if (!fileInput.files || !fileInput.files[0]) {
                alert(`⚠️ Bạn chưa chọn file PDF cho ${platformName}!`);
                return;
            }

            // --- LOADING EFFECT ---
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            const originalText = btnText.innerText;
            const originalIcon = btnIcon.className;

            const updateStatus = (msg) => {
                btnText.innerText = msg;
                btnIcon.className = "fa-solid fa-spinner fa-spin";
            };

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                
                let pdfBytes = null;
                let outFileName = "";

                if (currentTab === 'shopee') {
                    // === LOGIC SHOPEE ===
                    outFileName = "SHOPEE_V7_" + file.name;
                    updateStatus("Đang xử lý Shopee...");
                    pdfBytes = await runShopeeLogic(arrayBuffer, updateStatus);
                } else {
                    // === LOGIC TIKTOK ===
                    outFileName = "TIKTOK_SORT_" + file.name;
                    updateStatus("Đang xử lý TikTok...");
                    pdfBytes = await runTikTokLogic(arrayBuffer, updateStatus);
                }

                // --- DOWNLOAD ---
                updateStatus("Đang tải xuống...");
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = outFileName;
                link.click();

                // --- FINISH ---
                btnText.innerText = "THÀNH CÔNG!";
                btnIcon.className = "fa-solid fa-check";
                alert(`✅ Đã xử lý xong đơn hàng ${platformName}!`);

            } catch (e) {
                console.error(e);
                errorLog.innerText = "Lỗi: " + e.message;
                errorLog.classList.remove('hidden');
                alert("❌ Lỗi: " + e.message);
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    btnText.innerText = originalText;
                    btnIcon.className = originalIcon;
                }, 2000);
            }
        }

        // ==========================================
        // 1. LOGIC SHOPEE (V7)
        // ==========================================
        async function runShopeeLogic(arrayBuffer, statusCallback) {
            statusCallback("Đang đọc file Shopee...");
            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
            const pdf = await loadingTask.promise;
            const totalPages = pdf.numPages;
            
            let pagesData = [];
            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(s => s.str).join(' ');
                pagesData.push({ index: i - 1, text: text, pageNo: i });
                if(i % 50 === 0) statusCallback(`Đọc trang ${i}/${totalPages}...`);
            }

            statusCallback("Đang phân loại đơn...");
            const buckets = classifyPagesV5(pagesData);

            statusCallback("Đang sắp xếp...");
            const sortedIndices = getPrintOrder(buckets);

            statusCallback("Đang tạo file PDF...");
            const { PDFDocument } = PDFLib;
            const srcDoc = await PDFDocument.load(arrayBuffer);
            const newDoc = await PDFDocument.create();

            const copiedPages = await newDoc.copyPages(srcDoc, sortedIndices);
            copiedPages.forEach(p => newDoc.addPage(p));

            return await newDoc.save();
        }

        // --- Helper Shopee ---
        function classifyPagesV5(pages) {
            const buckets = { NBD: { BLACK: [], NUDE: [], COMBO: [] }, NB01: { BLACK: [], NUDE: [], COMBO: [] }, CB01: [], MULTI: [], OTHER: [] };
            const processedSet = new Set();
            pages.forEach(p => {
                const items = extractItems_(p.text);
                const totalQtyText = extractTotalQty_(p.text);
                const pIdx = p.index;
                if (items.length === 0) return;

                const isTextMulti = (totalQtyText && totalQtyText >= 2);
                const isListMulti = (items.length >= 2);
                const isQtyMulti  = items.some(it => it.qty >= 2);
                const rawSLCount = (p.text.match(/SL\s*:\s*\d+/gi) || []).length;
                const isRawMulti = (rawSLCount >= 2);

                if (isTextMulti || isListMulti || isQtyMulti || isRawMulti) {
                    addUnique(buckets.MULTI, items[0].size, pIdx, processedSet);
                    return; 
                }
                const it = items[0]; 
                if (it.code.includes('NBD')) {
                    const c = normalizeColor(it.color);
                    if (c) addUnique(buckets.NBD[c], it.size, pIdx, processedSet); else addUnique(buckets.OTHER, it.size, pIdx, processedSet);
                } else if (it.code.includes('NB01')) { 
                    const c = normalizeColor(it.color);
                    if (c) addUnique(buckets.NB01[c], it.size, pIdx, processedSet); else addUnique(buckets.OTHER, it.size, pIdx, processedSet);
                } else if (it.code.includes('CB01')) {
                    addUnique(buckets.CB01, it.size, pIdx, processedSet);
                } else {
                    addUnique(buckets.OTHER, it.size, pIdx, processedSet);
                }
            });
            pages.forEach(p => { if (!processedSet.has(p.index)) buckets.OTHER.push({ size: 'MISSING', index: p.index }); });
            return buckets;
        }

        function addUnique(bucketArr, size, index, set) {
            if (set.has(index)) return;
            bucketArr.push({ size: size, index: index });
            set.add(index);
        }

        function getPrintOrder(buckets) {
            const groupOrder = [ buckets.NBD.BLACK, buckets.NBD.NUDE, buckets.NBD.COMBO, buckets.NB01.BLACK, buckets.NB01.NUDE, buckets.NB01.COMBO, buckets.CB01, buckets.MULTI, buckets.OTHER ];
            let finalIndices = [];
            groupOrder.forEach(groupList => {
                groupList.sort((a, b) => sizeOrder_(a.size) - sizeOrder_(b.size));
                groupList.forEach(item => finalIndices.push(item.index));
            });
            return finalIndices;
        }
        function normalizeColor(c) {
            c = (c || '').toLowerCase();
            if (c.includes('combo')) return 'COMBO';
            if (c.includes('đen') || c.includes('black')) return 'BLACK';
            if (c.includes('nude') || c.includes('da') || c.includes('be') || c.includes('skin')) return 'NUDE';
            return null;
        }
        function sizeOrder_(size) {
            const order = ['XS/S','XS','S','M/L','M','L','XL/XXL','XL','XXL','2XL','3XL','4XL','5XL','6XL'];
            const idx = order.indexOf(size);
            return idx === -1 ? 999 : idx;
        }
        function extractTotalQty_(text) { const m = text.match(/Tổng\s*SL\s*sản\s*phẩm\s*:\s*(\d+)/i); return m ? parseInt(m[1]) : null; }
        function extractItems_(text) {
            let t = text.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
            t = t.replace(/Comb\s+o/gi, 'Combo').replace(/(\d)\s+(XL)/gi, '$1$2');
            const sizePattern = '(XS\\/S|M\\/L|XL\\/XXL|XS|S|M|L|XL|XXL|2XL|3XL|4XL|5XL|6XL)';
            const re = new RegExp(`-\\s*([A-Z0-9 -]+)\\s*,\\s*([^,]+?)\\s*,\\s*${sizePattern}\\s*,\\s*SL\\s*:\\s*(\\d+)`, 'gi');
            const results = [];
            let m;
            while ((m = re.exec(t)) !== null) {
                const code = (m[1]||'').toUpperCase().replace(/\s+/g, '');
                const color = (m[2]||'').trim();
                let size = (m[3]||'').toUpperCase().replace(/\s+/g, '');
                const qty = parseInt(m[4]);
                if (size === 'XSS') size = 'XS/S'; if (size === 'ML') size = 'M/L'; if (size === 'XLXXL') size = 'XL/XXL';
                if (code && size && qty > 0) results.push({ code, color, size, qty });
            }
            return results;
        }

        // ==========================================
        // 2. LOGIC TIKTOK (MỚI)
        // ==========================================
        const TK_SIZE_ORDER = ['XS', 'S', 'M', 'L', 'XL', '2XL', 'XXL', '3XL', 'XXXL', '4XL', '5XL', '6XL'];

        async function runTikTokLogic(arrayBuffer, statusCallback) {
            statusCallback("Đang đọc file TikTok...");
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const pdfWriter = await PDFLib.PDFDocument.load(arrayBuffer);
            const totalPages = pdfDoc.numPages;

            let groups = [];
            let currentGroup = null;

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdfDoc.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');
                const cleanText = removeAccents(text);

                // Phân tích dữ liệu (Strict Mode)
                const data = analyzeTextTikTok(cleanText);

                if (data.found) {
                    currentGroup = {
                        headIndex: i - 1, 
                        tailIndices: [],   
                        color: data.color,
                        size: data.size,
                        colorRank: data.colorRank,
                        sizeRank: data.sizeRank,
                        originalPage: i
                    };
                    groups.push(currentGroup);
                } else {
                    if (currentGroup) {
                        currentGroup.tailIndices.push(i - 1);
                    } else {
                        groups.push({
                            headIndex: i - 1, tailIndices: [],
                            color: 'Không rõ', size: '?', colorRank: 99, sizeRank: 99, originalPage: i
                        });
                    }
                }
                if(i % 50 === 0) statusCallback(`Đang quét trang ${i}/${totalPages}...`);
            }

            // SẮP XẾP
            statusCallback("Đang sắp xếp đơn...");
            groups.sort((a, b) => {
                // Ưu tiên 1: Màu (Đen trước -> Nude sau)
                if (a.colorRank !== b.colorRank) return a.colorRank - b.colorRank;
                // Ưu tiên 2: Size
                return a.sizeRank - b.sizeRank;
            });

            // TẠO PDF
            statusCallback("Đang tạo file sắp xếp...");
            const newPdf = await PDFLib.PDFDocument.create();
            
            for (const group of groups) {
                const [headPage] = await newPdf.copyPages(pdfWriter, [group.headIndex]);
                newPdf.addPage(headPage);
                if (group.tailIndices.length > 0) {
                    const tailPages = await newPdf.copyPages(pdfWriter, group.tailIndices);
                    tailPages.forEach(p => newPdf.addPage(p));
                }
            }

            return await newPdf.save();
        }

        // Helper TikTok
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d").replace(/Đ/g, "D").toLowerCase();
        }

        function analyzeTextTikTok(text) {
            let result = { found: false, color: '?', size: '?', colorRank: 99, sizeRank: 99 };
            const reverseSizes = [...TK_SIZE_ORDER].reverse();
            
            for (const size of reverseSizes) {
                // Regex tìm cặp "Màu + Dấu phẩy + Size"
                const regex = new RegExp(`(den|black|nude|da|kem)\\s*,\\s*(${size})\\b`, 'i');
                const match = text.match(regex);

                if (match) {
                    const colorKey = match[1].toLowerCase();
                    result.found = true;
                    result.size = size;
                    result.sizeRank = TK_SIZE_ORDER.indexOf(size);
                    
                    if (colorKey === 'den' || colorKey === 'black') {
                        result.color = 'ĐEN';
                        result.colorRank = 1;
                    } else {
                        result.color = 'NUDE';
                        result.colorRank = 2;
                    }
                    break;
                }
            }
            return result;
        }

    </script>
</body>
</html>
